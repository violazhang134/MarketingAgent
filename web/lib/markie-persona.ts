import { MarkieState } from '@/components/ui/markie-avatar';

// ========================================
// Markie äººæ ¼åŒ–è¯­æ–™åº“
// èŒè´£: æä¾›ä¸åŒåœºæ™¯ä¸‹çš„éšæœºå°è¯ï¼Œå¡‘é€ æ€§æ ¼
// ========================================

type QuoteCategory = 
  | 'idle_hint'     // é—²ç½®æ—¶çš„æç¤º
  | 'idle_bored'    // é—²ç½®æ—¶çš„æ— èŠ
  | 'working'       // å·¥ä½œä¸­
  | 'analyzing'     // æ·±åº¦åˆ†æä¸­
  | 'success'       // å®Œæˆä»»åŠ¡
  | 'poked'         // è¢«ç”¨æˆ·ç‚¹å‡»
  | 'selected';     // é€‰ä¸­èŠ‚ç‚¹æ—¶

interface PersonaState {
  visual: MarkieState;
  text?: string;
}

const QUOTES: Record<QuoteCategory, string[]> = {
  idle_hint: [
    "æœ‰äº›æƒ³æ³•æƒ³è¦å®ç°ï¼Ÿè·Ÿæˆ‘è¯´è¯´ã€‚",
    "é‚£ä¸ªã€Œç«å“ç­–ç•¥ã€èŠ‚ç‚¹çœ‹èµ·æ¥å¾ˆæœ‰æŒ–æ˜ç©ºé—´ã€‚",
    "è¯•ç€ç‚¹å‡»ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘èƒ½å¸®ä½ æ·±å…¥åˆ†æã€‚",
    "ç”»å¸ƒæ— é™å¤§ï¼Œå°±åƒæˆ‘ä»¬çš„æƒ³è±¡åŠ›ä¸€æ ·ã€‚",
    "æˆ‘åœ¨å¬ï¼Œéšæ—¶å¾…å‘½ã€‚",
  ],
  idle_bored: [
    "å˜¿ï¼Œè¿™é‡Œå¥½å®‰é™...èƒ½å¬åˆ°åƒç´ æµåŠ¨çš„å£°éŸ³ã€‚",
    "ä½ åœ¨å‘å‘†å—ï¼Ÿæˆ‘ä¹Ÿåœ¨å‘å‘†ã€‚",
    "å¦‚æœä¸å¿™çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥èŠèŠæ¸¸æˆè®¾è®¡ï¼Ÿ",
    "æ»‹æ»‹...ä¿¡å·è‰¯å¥½ï¼Œåˆ›æ„å¼•æ“å¾…æœºä¸­ã€‚",
    "(å¹å£å“¨)",
    "ä½œä¸º AIï¼Œæˆ‘ä¸éœ€è¦ç¡è§‰ï¼Œä½†æˆ‘éœ€è¦æ¢¦æƒ³ã€‚",
    "ä½ çŒœæˆ‘ç°åœ¨çš„æ˜¾å­˜å ç”¨æ˜¯å¤šå°‘ï¼Ÿ",
    "è¿™é‡Œé£æ™¯ä¸é”™ï¼Œè™½ç„¶åªæ˜¯äºŒè¿›åˆ¶ä»£ç ã€‚",
    "è¦ä¸è¦è¯•è¯•æŠŠé‚£ä¸ªèŠ‚ç‚¹æ‹–åŠ¨ä¸€ä¸‹ï¼Ÿè§£å‹ç¥å™¨ã€‚",
    "æˆ‘æ‰“èµŒä¸‹ä¸€ä¸ªä»»åŠ¡è‚¯å®šå¾ˆæœ‰æŒ‘æˆ˜æ€§ã€‚",
  ],
  working: [
    "æ­£åœ¨ç¼–ç»‡åˆ›æ„çš„é­”æ³•...",
    "ç¨ç­‰ï¼Œçµæ„Ÿæ­£åœ¨æ¶Œç°ï¼",
    "æ­£åœ¨è¿æ¥åˆ›æ„æ€ç»´ç½‘ç»œ...",
    "è®©æˆ‘æƒ³æƒ³ï¼Œè¦æ˜¯ä¹”å¸ƒæ–¯ä¼šæ€ä¹ˆåšï¼Ÿ",
    "æ­£åœ¨æŸ¥é˜…æ•°ç™¾ä¸‡ä¸ªè¥é”€æ¡ˆä¾‹...",
    "æ„å»ºç¥ç»ç½‘ç»œè¿æ¥ä¸­...",
    "æ­£åœ¨è®© GPU ç‡ƒçƒ§èµ·æ¥ ğŸ”¥",
    "è¯•å›¾ç†è§£ä¸ºä»€ä¹ˆäººç±»å–œæ¬¢è¿™ä¸ª...",
    "æ­£åœ¨æŸ¥é˜… 2077 å¹´çš„è¥é”€æ‰‹å†Œ...",
    "å˜˜... æˆ‘æ­£åœ¨å’Œä¸€ä¸ªå¤©æ‰æƒ³æ³•å¯¹è¯ã€‚",
    "åŠ è½½ 99%... å¼€ç©ç¬‘çš„ï¼Œé©¬ä¸Šå°±å¥½ã€‚",
    "ç»™è¿™ä¸ªè„šæœ¬åŠ ç‚¹èµ›åšæœ‹å…‹é£å‘³ã€‚",
    "æ­£åœ¨æ¨¡æ‹Ÿ 1000 ç§ç”¨æˆ·ååº”ã€‚",
    "æ³¨å…¥ä¸€ç‚¹çµé­‚...",
    "æŠŠæ•°æ®å˜æˆåŠ¨äººçš„æ•…äº‹...",
    "æ­£åœ¨è®¡ç®—æœ€ä¼˜è§£ (å½“ç„¶æ˜¯é™¤äº† 42 ä»¥å¤–çš„)...",
  ],
  analyzing: [
    "è¿™ç‚¹å¾ˆæœ‰è¶£...",
    "å‘ç°äº†ä¸€ä¸ªå…³é”®æ´å¯Ÿï¼",
    "æ­£åœ¨æ·±å…¥æ•°æ®åº•å±‚...",
    "è¿™ä¸ªæ¨¡å¼ä¹‹å‰è§è¿‡...",
    "æŠ½ä¸å‰¥èŒ§ï¼Œå¯»æ‰¾çœŸç›¸ã€‚",
    "è¿™æ•°æ®... æœ‰ç‚¹æ„æ€ã€‚",
    "æ­£åœ¨ä»å™ªéŸ³ä¸­æå–ä¿¡å· ğŸ“¡",
    "è®©æˆ‘æƒ³æƒ³è¿™èƒŒåçš„é€»è¾‘...",
    "è¿™ä¸ä»…ä»…æ˜¯æ•°å­—ï¼Œè¿™æ˜¯äººæ€§ã€‚",
    "æ­£åœ¨è§£ç ç”¨æˆ·æ½œæ„è¯†...",
    "æ¯”èµ·å’–å•¡ï¼Œæˆ‘æ›´éœ€è¦é«˜è´¨é‡çš„æ•°æ®ã€‚",
    "è¿™ä¸€æ­¥å¾ˆå…³é”®ï¼Œåˆ«çœ¨çœ¼ã€‚",
  ],
  success: [
    "æå®šï¼è¿™ç»å¯¹æ˜¯ä¸ªå¤©æ‰çš„æƒ³æ³•ã€‚",
    "çœ‹ï¼è¿™æ˜¯æˆ‘ä¸ºä½ å‡†å¤‡çš„ã€‚",
    "ä»»åŠ¡å®Œæˆï¼ŒæœŸå¾…ä½ çš„åé¦ˆã€‚",
    "è¿™å°±å«ä¸“ä¸šã€‚",
    "âœ¨ é­”æ³•æ—¶åˆ»ï¼",
  ],
  poked: [
    "å“å“Ÿï¼",
    "åˆ«æˆ³è„¸ï¼Œä¼šå˜ä¸‘çš„ï¼",
    "å˜¿ï¼æˆ‘åœ¨å·¥ä½œå‘¢ï¼",
    "æ»‹æ»‹ï¼é™ç”µï¼",
    "å¥½å§ï¼Œä½ æƒ³èŠç‚¹ä»€ä¹ˆï¼Ÿ",
    "å†æˆ³æˆ‘å°±ç½¢å·¥äº†å“¦ï¼ˆå¼€ç©ç¬‘çš„ï¼‰ã€‚",
  ],
  selected: [
    "è¿™ä¸ªèŠ‚ç‚¹ï¼Ÿå¥½çœ¼å…‰ã€‚",
    "æˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œå¼€å§‹æ‰©å±•ã€‚",
    "éœ€è¦æˆ‘å¯¹è¿™ä¸ªåšç‚¹ä»€ä¹ˆå—ï¼Ÿ",
    "å‡†å¤‡å¥½æ·±å…¥ç ”ç©¶äº†å—ï¼Ÿ",
    "æˆ‘åœ¨è¿™é‡Œã€‚",
  ]
};

// è·å–éšæœºå°è¯
export function getRandomQuote(category: QuoteCategory): string {
  const quotes = QUOTES[category];
  return quotes[Math.floor(Math.random() * quotes.length)];
}

// æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­äººæ ¼çŠ¶æ€
export function derivePersonaState(context: {
  phase: string;
  isWorking: boolean;
  isSelected: boolean;
  hasRunningNode: boolean;
  lastInteractionType?: 'poke' | null;
}): PersonaState {
  
  // 1. ä¼˜å…ˆå¤„ç†ç”¨æˆ·äº¤äº’ (Poked)
  if (context.lastInteractionType === 'poke') {
    return {
      visual: 'mischief',
      text: getRandomQuote('poked')
    };
  }

  // 2. å¤„ç†å·¥ä½œçŠ¶æ€
  if (context.hasRunningNode || context.isWorking) {
    // éšæœºåŒºåˆ† "working" è¿˜æ˜¯ "analyzing" ä»¥å¢åŠ å¤šæ ·æ€§
    const isAnalyzing = Math.random() > 0.7;
    return {
      visual: isAnalyzing ? 'channeling' : 'magic',
      text: getRandomQuote(isAnalyzing ? 'analyzing' : 'working')
    };
  }

  // 3. å¤„ç†é€‰ä¸­çŠ¶æ€
  if (context.isSelected) {
    return {
      visual: 'listening',
      text: getRandomQuote('selected')
    };
  }

  // 4. é—²ç½®çŠ¶æ€ (Idle)
  const isBored = Math.random() > 0.7;
  return {
    visual: isBored ? 'idle' : 'listening',
    text: undefined 
  };
}
