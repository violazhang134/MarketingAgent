# ä¸»è§’ä¸€è‡´æ€§å·¥ä½œæµ (Character Consistency Workflow)

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

è§£å†³ç”Ÿæˆç´ æä¸­æ¸¸æˆä¸»è§’å½¢è±¡ä¸ç»Ÿä¸€çš„é—®é¢˜ï¼Œç¡®ä¿å°é¢ã€å®æœºæˆªå›¾å’Œ Banner ä¸­çš„è§’è‰²å…·æœ‰ä¸€è‡´çš„å¤–è§‚ç‰¹å¾ï¼ˆå‘å‹ã€ç€è£…ã€ç”»é£ï¼‰ã€‚

## ğŸ”„ 2-Stage ä¸²è¡Œç”Ÿæˆæœºåˆ¶

ä¸ºäº†å®ç°ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å°†åŸæœ‰çš„å¹¶è¡Œç”Ÿæˆæ”¹é€ ä¸º **2-Stage ä¸²è¡Œå·¥ä½œæµ**ï¼š

### ç¬¬ä¸€é˜¶æ®µï¼šç¡®ç«‹ä¸»è§’ (Stage 1: The Protagonist)

- **ç›®æ ‡**: ç”Ÿæˆä¸€å¼ é«˜ç²¾åº¦ã€æ ‡å‡†åŒ–çš„ä¸»è§’è®¾å®šå›¾ã€‚
- **Prompt ç­–ç•¥**:
  - èšç„¦è§’è‰²è®¾è®¡ï¼ˆä¸‰è§†å›¾ã€å…¨èº«ç…§ï¼‰ã€‚
  - æ’é™¤å¤æ‚èƒŒæ™¯ï¼Œç¡®ä¿ä¸»ä½“æ¸…æ™°ã€‚
  - å¼ºè°ƒç”»é£ IDï¼ˆå¦‚â€œé«˜é¥±å’Œåº¦å¡é€šâ€ï¼‰ã€‚
- **äº§å‡º**: `character_ref_01.png` (ä¸»è§’å‚è€ƒå›¾ Reference Image)

### ç¬¬äºŒé˜¶æ®µï¼šä¸€è‡´æ€§ç”Ÿæˆ (Stage 2: Contextual Generation)

- **æ ¸å¿ƒé€»è¾‘**: **å¿…é¡»å°†ç¬¬ä¸€é˜¶æ®µç”Ÿæˆçš„ `character_ref_01.png` ä½œä¸ºå¼ºçº¦æŸè¾“å…¥ä¼ ç»™ AIã€‚**
- **è¾“å…¥**:
  1. **Text Prompt**: æè¿°å…·ä½“åœºæ™¯ï¼ˆå¦‚â€œæˆ˜æ–—ä¸­â€ã€â€œæ¢ç´¢æ£®æ—â€ï¼‰ã€‚
  2. **Reference Image**: ä¼ å…¥ Stage 1 çš„å›¾ç‰‡ URLã€‚
- **æŠ€æœ¯å®ç°**:
  - åœ¨è°ƒç”¨ `generateMarketingImagePrompts` æ—¶ï¼Œæ˜¾å¼ä¼ å…¥ `refImageUrl`ã€‚
  - API å±‚æ„å»ºè¯·æ±‚æ—¶ï¼Œå°†å›¾ç‰‡ URL æ³¨å…¥ `image_url` æˆ– `reference_image` å‚æ•°ã€‚
  - åœ¨ Prompt ä¸­å¢åŠ â€œåŸºäºå‚è€ƒå›¾è®¾è®¡ (Based on character sheet)â€çš„æ–‡æœ¬æŒ‡å¼•ã€‚
- **äº§å‡ºç´ æ**:
  - ğŸ–¼ï¸ **æ¸¸æˆå°é¢**: å°†å‚è€ƒå›¾ä¸­çš„ä¸»è§’èå…¥é«˜å“è´¨å®£ä¼ æ„å›¾ã€‚
  - ğŸ® **å®æœºæˆªå›¾**: ä¿æŒä¸»è§’èƒŒå½±/ä¾§å½±ä¸å‚è€ƒå›¾ä¸€è‡´ã€‚
  - ğŸš© **Banner**: ç¡®ä¿æ¨ªå¹…å¹¿å‘Šä¸­çš„è§’è‰²å½¢è±¡ä¸å´©åã€‚

## ğŸ›  æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æ•°æ®ç»“æ„ (`campaign.ts`)

åœ¨ `GeneratedAssets` ä¸­æ–°å¢ä¸»è§’å‚è€ƒå­—æ®µï¼š

```typescript
interface GeneratedAssets {
  // ...
  characterRef?: ImageAsset; // ä¸€è‡´æ€§çš„å”¯ä¸€çœŸç†æ¥æº (Source of Truth)
}
```

### 2. çŠ¶æ€ç®¡ç† (`campaign-store.ts`)

æ”¹é€  `generateAssetsWorkflow`ï¼š

1. **æ‰§è¡Œ Stage 1**: è°ƒç”¨ `generateCharacterRef`ï¼Œç­‰å¾…ç”Ÿæˆå®Œæˆã€‚
2. **è·å–ä¸Šä¸‹æ–‡**: æ‹¿åˆ°ç”Ÿæˆå¥½çš„ `characterImageUrl`ã€‚
3. **æ‰§è¡Œ Stage 2**: å°† `characterImageUrl` ä½œä¸ºå‚æ•°ä¼ ç»™ `generateMarketingImagePrompts`ã€‚
4. **API è°ƒç”¨**: åœ¨å¾ªç¯ç”Ÿæˆåç»­ç´ ææ—¶ï¼ŒåŠ¡å¿…æºå¸¦ `image_url` å‚æ•°ã€‚

### 3. API ä¸ Prompt å·¥ç¨‹ (`creative-engine.ts`)

- **Native Img2Img Support**: ç¡®è®¤ Seedream 4.5 æ¨¡å‹åŸç”Ÿæ”¯æŒå‚è€ƒå›¾è¾“å…¥ã€‚
- **Parameter Injection**:
  - å­—æ®µå: `image` (Type: `array[string]`)
  - ç”¨æ³•: å°† Stage 1 ç”Ÿæˆçš„å›¾ç‰‡ URL æ”¾å…¥ `image` æ•°ç»„ä¸­ã€‚
  - Prompt: å¼ºåˆ¶æ³¨å…¥æŒ‡å¼•æ–‡æœ¬ï¼šâ€œ**è¯·æŠŠå‚è€ƒå›¾ä¸­çš„è§’è‰²ä½œä¸ºæœ¬æ¸¸æˆçš„ä¸»è§’ï¼Œä¿æŒå¤–è§‚ä¸€è‡´**â€ï¼Œç¡®ä¿æ¨¡å‹ç†è§£å‚è€ƒå›¾çš„ç”¨é€”ã€‚

## ğŸ¨ æç¤ºè¯é…ç½® (Prompt Configuration)

å¦‚æœæ‚¨æƒ³è°ƒæ•´ç”Ÿæˆå›¾ç‰‡çš„é£æ ¼æè¿°æˆ–æ¨¡æ¿ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹æ–‡ä»¶ï¼š

### 1. æ ¸å¿ƒæ¨¡æ¿æ–‡ä»¶

- **è·¯å¾„**: `lib/data/marketing-prompts.ts`
- **å†…å®¹**: åŒ…å«äº†æ‰€æœ‰ç´ æç±»å‹çš„ Base Promptï¼Œä¾‹å¦‚ï¼š
  - `gameCover`: å°é¢å›¾æ¨¡æ¿
  - `gameplayScreenshot`: å®æœºæˆªå›¾æ¨¡æ¿
  - `characterSheet`: ä¸»è§’è®¾å®šå›¾æ¨¡æ¿
- **ä¿®æ”¹æ–¹å¼**: ç›´æ¥ç¼–è¾‘ `basePrompt` å‡½æ•°ä¸­çš„å­—ç¬¦ä¸²å³å¯ã€‚

### 2. é£æ ¼æ˜ å°„ä¸ç»„è£…

- **è·¯å¾„**: `lib/engines/creative-engine.ts`
- **å‡½æ•°**: `generateMarketingImagePrompts`
- **å†…å®¹**: è¿™é‡Œå®šä¹‰äº† Hook (å¦‚ 'challenge') å¦‚ä½•æ˜ å°„åˆ°å…·ä½“çš„é£æ ¼è¯ (å¦‚ 'é«˜é¥±å’Œåº¦å¡é€š')ï¼Œä»¥åŠå¦‚ä½•å°† Reference çš„ä¸€è‡´æ€§æŒ‡ä»¤æ‹¼æ¥åˆ°æœ€ç»ˆ Prompt ä¸­ã€‚

## ğŸ“‹ ä»»åŠ¡æ¸…å•

- [x] åˆ›å»ºæ­¤æŠ€æœ¯æ–‡æ¡£
- [x] é‡æ„ Workflow ä¸º 2 é˜¶æ®µä¸²è¡Œæ¨¡å¼
- [x] å®ç° `generateCharacterPrompt` å¼•æ“å‡½æ•°
- [x] æ›´æ–° API æ¥å£ä»¥æ”¯æŒ `image_url` å‚æ•°é€ä¼ 
- [x] UI ç•Œé¢æ–°å¢â€œä¸»è§’è®¾å®šâ€å±•ç¤ºåŒº
